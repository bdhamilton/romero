<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Romero Text Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            background: #fff;
            color: #222;
        }

        .page {
            max-width: 960px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* Header */
        .header {
            padding: 40px 0 8px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: normal;
            color: #222;
        }
        .header h1 span {
            color: #5f6368;
            font-size: 16px;
            font-weight: normal;
            margin-left: 4px;
        }
        .subtitle {
            color: #5f6368;
            font-size: 14px;
            margin-top: 4px;
        }

        /* Language toggle */
        .lang-toggle {
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }
        .lang-toggle button {
            font-size: 14px;
            padding: 6px 20px;
            border: 1px solid #dadce0;
            background: #f8f9fa;
            color: #5f6368;
            cursor: pointer;
        }
        .lang-toggle button:first-child {
            border-radius: 20px 0 0 20px;
        }
        .lang-toggle button:last-child {
            border-radius: 0 20px 20px 0;
            border-left: none;
        }
        .lang-toggle button.active {
            background: #4285f4;
            border-color: #4285f4;
            color: #fff;
        }

        /* Search */
        .search-row {
            display: flex;
            margin-top: 20px;
            gap: 0;
        }
        .search-row input {
            flex: 1;
            font-size: 16px;
            padding: 10px 16px;
            border: 1px solid #dfe1e5;
            border-radius: 24px 0 0 24px;
            outline: none;
        }
        .search-row input:focus {
            border-color: #4285f4;
            box-shadow: 0 0 0 1px #4285f4;
        }
        .search-row button {
            font-size: 14px;
            padding: 10px 24px;
            background: #4285f4;
            color: #fff;
            border: 1px solid #4285f4;
            border-radius: 0 24px 24px 0;
            cursor: pointer;
            white-space: nowrap;
        }
        .search-row button:hover {
            background: #3367d6;
            border-color: #3367d6;
        }

        /* Controls */
        .controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-top: 8px;
            font-size: 13px;
            color: #5f6368;
        }
        .controls select {
            font-size: 13px;
            padding: 4px 8px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            color: #3c4043;
            background: #fff;
        }
        .controls label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        /* Examples */
        .examples {
            margin-top: 12px;
            font-size: 13px;
            color: #5f6368;
        }
        .examples a {
            color: #4285f4;
            text-decoration: none;
            cursor: pointer;
        }
        .examples a:hover {
            text-decoration: underline;
        }

        /* Status (transient messages above chart) */
        .status {
            margin-top: 16px;
            font-size: 13px;
            color: #5f6368;
        }
        .status:empty {
            display: none;
        }

        /* Chart */
        .chart-container {
            margin-top: 16px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 16px 16px 8px;
            background: #fff;
        }

        /* Drilldown */
        .drilldown {
            margin-top: 16px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 16px;
            background: #f8f9fa;
        }
        .drilldown h3 {
            font-size: 14px;
            font-weight: 600;
            color: #202124;
            margin-bottom: 12px;
        }
        .drilldown h3 + ul + h3 {
            margin-top: 16px;
        }
        .drilldown-list {
            list-style: none;
        }
        .drilldown-list li {
            padding: 8px 0;
            border-bottom: 1px solid #e8eaed;
            font-size: 14px;
            display: flex;
            gap: 12px;
        }
        .drilldown-list li:last-child {
            border-bottom: none;
        }
        .drilldown-count {
            color: #4285f4;
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }
        .drilldown-date {
            color: #5f6368;
            min-width: 130px;
            white-space: nowrap;
        }
        .drilldown-title a {
            color: #202124;
            text-decoration: none;
        }
        .drilldown-title a:hover {
            color: #4285f4;
            text-decoration: underline;
        }

        /* Footer */
        .footer {
            margin-top: 48px;
            padding: 24px 0;
            border-top: 1px solid #e8eaed;
            font-size: 13px;
            color: #5f6368;
            text-align: center;
        }
        .footer a {
            color: #4285f4;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="header">
            <h1>Romero Text Explorer</h1>
            <p class="subtitle">Word frequency in Archbishop Romero's homilies, 1977–1980</p>
        </div>

        <div class="lang-toggle" id="lang-toggle">
            <button data-lang="es" class="active">Espa&#241;ol</button>
            <button data-lang="en">English</button>
        </div>

        <form id="search-form">
            <div class="search-row">
                <input type="text" id="term" name="term"
                       placeholder="Enter words, phrases, or wildcards (liber*) separated by commas..."
                       autocomplete="off" autofocus>
                <button type="submit">Search</button>
            </div>
        </form>

        <div class="examples" id="examples"></div>

        <div class="status" id="status"></div>

        <div class="chart-container" id="chart-container" style="display:none">
            <canvas id="chart"></canvas>
            <div class="controls">
                <label for="norm">Y-axis:</label>
                <select id="norm">
                    <option value="count">Raw count</option>
                    <option value="per_10k_words" selected>Per 10,000 words</option>
                    <option value="per_homily">Per homily</option>
                </select>
                <label title="Moving average: each point is averaged with its neighbors. 0 = raw data, 1 = 3-month window, 2 = 5-month, 3 = 7-month. Higher values produce smoother curves that highlight long-term trends.">
                    Smoothing:
                    <select id="smoothing">
                        <option value="0">0</option>
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </label>
                <label>
                    <input type="checkbox" id="show-events">
                    Show historical events
                </label>
            </div>
        </div>

        <div class="drilldown" id="drilldown" style="display:none"></div>

        <div class="footer">
            <p>Data sourced from <a href="https://www.romerotrust.org.uk" target="_blank">The Romero Trust</a>
            &middot; <a href="{{ url_for('browse') }}">Browse all homilies</a></p>
        </div>
    </div>

<script>
const SEARCH_URL = {{ url_for('api_search') | tojson }};
const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

const LANG_CONFIG = {
    es: {
        defaultTerm: 'amor, justicia',
        examples: `Try:
            <a data-term="justicia">justicia</a>,
            <a data-term="esperanza">esperanza</a>,
            <a data-term="pueblo de dios">pueblo de dios</a>
            &middot; Wildcards:
            <a data-term="esper*">esper*</a>
            &middot; Compare:
            <a data-term="justicia, paz, violencia">justicia, paz, violencia</a>,
            <a data-term="pueblo, iglesia">pueblo, iglesia</a>`,
    },
    en: {
        defaultTerm: 'love, justice',
        examples: `Try:
            <a data-term="justice">justice</a>,
            <a data-term="hope">hope</a>,
            <a data-term="people of God">people of God</a>
            &middot; Wildcards:
            <a data-term="liber*">liber*</a>
            &middot; Compare:
            <a data-term="justice, peace, violence">justice, peace, violence</a>,
            <a data-term="church, kingdom">church, kingdom</a>`,
    },
};

let currentLang = 'es';

const COLORS = [
    { border: '#4285f4', bg: 'rgba(66, 133, 244, 0.08)' },
    { border: '#ea4335', bg: 'rgba(234, 67, 53, 0.08)' },
    { border: '#34a853', bg: 'rgba(52, 168, 83, 0.08)' },
    { border: '#fbbc04', bg: 'rgba(251, 188, 4, 0.08)' },
    { border: '#9334e6', bg: 'rgba(147, 52, 230, 0.08)' },
    { border: '#ff6d01', bg: 'rgba(255, 109, 1, 0.08)' },
    { border: '#46bdc6', bg: 'rgba(70, 189, 198, 0.08)' },
    { border: '#e52592', bg: 'rgba(229, 37, 146, 0.08)' },
];

const HISTORICAL_EVENTS = [
    { month: 'Mar 1977', label: 'Rutilio Grande killed' },
    { month: 'Jan 1979', label: 'Puebla Conference' },
    { month: 'May 1979', label: 'Cathedral massacre' },
    { month: 'Oct 1979', label: 'Military coup' },
    { month: 'Mar 1980', label: 'Romero assassinated' },
];

function formatMonth(ym) {
    const [y, m] = ym.split('-');
    return MONTH_NAMES[parseInt(m) - 1] + ' ' + y;
}

function smooth(values, window) {
    if (window === 0) return values;
    return values.map((_, i, arr) => {
        let sum = 0, n = 0;
        for (let j = i - window; j <= i + window; j++) {
            if (j >= 0 && j < arr.length) { sum += arr[j]; n++; }
        }
        return sum / n;
    });
}

let chartInstance = null;
let lastResults = [];  // array of search results, one per term

function getValues(data, metric) {
    return data.months.map(m => {
        if (metric === 'per_10k_words') return m.per_10k_words;
        if (metric === 'per_homily') return m.per_homily;
        return m.count;
    });
}

function metricLabel(metric) {
    if (metric === 'per_10k_words') return 'per 10,000 words';
    if (metric === 'per_homily') return 'per homily';
    return 'occurrences';
}

function renderChart(results) {
    const container = document.getElementById('chart-container');
    const drilldown = document.getElementById('drilldown');
    const metric = document.getElementById('norm').value;
    const smoothing = parseInt(document.getElementById('smoothing').value);
    const multiTerm = results.length > 1;

    // All results share the same month labels (search returns all 37 months)
    const labels = results[0].months.map(m => formatMonth(m.month));

    // Build datasets
    const datasets = results.map((data, i) => {
        const color = COLORS[i % COLORS.length];
        const raw = getValues(data, metric);
        const values = smooth(raw, smoothing);
        return {
            label: data.term,
            data: values,
            borderColor: color.border,
            backgroundColor: color.bg,
            fill: !multiTerm,  // fill only for single term
            tension: 0.25,
            pointRadius: 3,
            pointHoverRadius: 6,
            pointBackgroundColor: color.border,
            pointBorderColor: '#fff',
            pointBorderWidth: 1.5,
            borderWidth: 2,
        };
    });


    // Build historical event annotations
    const showEvents = document.getElementById('show-events').checked;
    const annotations = {};
    if (showEvents) HISTORICAL_EVENTS.forEach((evt, i) => {
        annotations['event' + i] = {
            type: 'line',
            scaleID: 'x',
            value: evt.month,
            borderColor: 'rgba(66, 133, 244, 0.45)',
            borderWidth: 1.5,
            borderDash: [4, 4],
            label: {
                display: true,
                content: evt.label,
                position: 'start',
                backgroundColor: 'rgba(50, 100, 214, 0.8)',
                color: '#fff',
                font: { size: 11, weight: 'bold' },
                padding: { x: 6, y: 3 },
                rotation: -90,
            }
        };
    });

    if (chartInstance) chartInstance.destroy();

    container.style.display = 'block';
    drilldown.style.display = 'none';

    chartInstance = new Chart(document.getElementById('chart'), {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2.2,
            interaction: {
                intersect: false,
                mode: 'index',
            },
            plugins: {
                annotation: { annotations },
                legend: {
                    display: multiTerm,
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 16,
                        font: { size: 13 },
                    }
                },
                tooltip: {
                    backgroundColor: '#fff',
                    titleColor: '#202124',
                    bodyColor: '#5f6368',
                    borderColor: '#dadce0',
                    borderWidth: 1,
                    cornerRadius: 8,
                    padding: 10,
                    displayColors: multiTerm,
                    callbacks: {
                        title: function(items) {
                            return items[0].label;
                        },
                        label: function(item) {
                            const data = results[item.datasetIndex];
                            const m = data.months[item.dataIndex];
                            const val = item.parsed.y;
                            const label = metricLabel(metric);
                            let s = Number.isInteger(val) ? val.toLocaleString() : val.toFixed(1);
                            let prefix = multiTerm ? data.term + ': ' : '';
                            let line = prefix + s + ' ' + label;
                            if (smoothing > 0) {
                                line += ' (' + (smoothing * 2 + 1) + '-mo avg)';
                            } else if (metric !== 'count') {
                                line += ' (' + m.count + ' total)';
                            }
                            return line;
                        },
                        afterBody: function(items) {
                            if (multiTerm) return '';
                            const m = results[0].months[items[0].dataIndex];
                            return m.num_homilies + ' homilies this month';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: '#f1f3f4' },
                    ticks: {
                        font: { size: 11 },
                        color: '#5f6368',
                        maxRotation: 45,
                        autoSkip: true,
                        maxTicksLimit: 18,
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: '#f1f3f4' },
                    ticks: {
                        font: { size: 11 },
                        color: '#5f6368',
                    },
                    title: {
                        display: true,
                        text: metricLabel(metric),
                        color: '#5f6368',
                        font: { size: 12 },
                    }
                }
            },
            onClick: function(evt, elements) {
                if (elements.length > 0) {
                    const el = elements[0];
                    showDrilldown(results, el.index, el.datasetIndex);
                }
            }
        }
    });
}

function formatDate(dateStr) {
    const [y, m, d] = dateStr.split('-');
    const date = new Date(y, parseInt(m) - 1, parseInt(d));
    return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
}

function showDrilldown(results, monthIndex, datasetIndex) {
    const el = document.getElementById('drilldown');
    const multiTerm = results.length > 1;

    // For multi-term, show all terms for this month. For single-term, same as before.
    const termsToShow = multiTerm ? results : [results[datasetIndex]];
    const monthLabel = formatMonth(results[0].months[monthIndex].month);

    let html = '';
    for (const data of termsToShow) {
        const m = data.months[monthIndex];
        if (m.count === 0) continue;

        const homilies = m.homilies.slice().sort((a, b) => b.count - a.count);
        const color = COLORS[results.indexOf(data) % COLORS.length];

        if (multiTerm) {
            html += `<h3 style="margin-top: 1em; color: ${color.border}">${monthLabel} — ${m.count} occurrence${m.count !== 1 ? 's' : ''} of \u201c${data.term}\u201d in ${homilies.length} homil${homilies.length !== 1 ? 'ies' : 'y'}</h3>`;
        } else {
            html += `<h3>${monthLabel} — ${m.count} occurrence${m.count !== 1 ? 's' : ''} of \u201c${data.term}\u201d in ${homilies.length} homil${homilies.length !== 1 ? 'ies' : 'y'}</h3>`;
        }
        html += '<ul class="drilldown-list">';
        for (const h of homilies) {
            const title = h.detail_url
                ? `<a href="${h.detail_url}" target="_blank">${h.title}</a>`
                : h.title;
            html += `<li>
                <span class="drilldown-count">${h.count}x</span>
                <span class="drilldown-date">${formatDate(h.date)}</span>
                <span class="drilldown-title">${title}</span>
            </li>`;
        }
        html += '</ul>';
    }

    if (!html) {
        el.style.display = 'none';
        return;
    }

    el.innerHTML = html;
    el.style.display = 'block';
}

function showTopHomilies(results) {
    const el = document.getElementById('drilldown');
    const multiTerm = results.length > 1;

    let html = '';
    for (const data of results) {
        // Collect all homilies across all months
        const all = [];
        for (const m of data.months) {
            for (const h of m.homilies) all.push(h);
        }
        if (all.length === 0) continue;

        all.sort((a, b) => b.count - a.count);
        const top = all.slice(0, 5);
        const color = COLORS[results.indexOf(data) % COLORS.length];

        const heading = multiTerm
            ? `<h3 style="color: ${color.border}">Top homilies for \u201c${data.term}\u201d (${data.total_count.toLocaleString()} mention${data.total_count !== 1 ? 's' : ''} across ${data.total_homilies} homil${data.total_homilies !== 1 ? 'ies' : 'y'})</h3>`
            : `<h3>Top homilies for \u201c${data.term}\u201d (${data.total_count.toLocaleString()} mention${data.total_count !== 1 ? 's' : ''} across ${data.total_homilies} homil${data.total_homilies !== 1 ? 'ies' : 'y'})</h3>`;
        html += heading;

        html += '<ul class="drilldown-list">';
        for (const h of top) {
            const title = h.detail_url
                ? `<a href="${h.detail_url}" target="_blank">${h.title}</a>`
                : h.title;
            html += `<li>
                <span class="drilldown-count">${h.count}x</span>
                <span class="drilldown-date">${formatDate(h.date)}</span>
                <span class="drilldown-title">${title}</span>
            </li>`;
        }
        html += '</ul>';
    }

    if (html) {
        el.innerHTML = html;
        el.style.display = 'block';
    }
}

function parseTerms(input) {
    return input.split(',').map(t => t.trim()).filter(t => t.length > 0);
}

async function doSearch(input) {
    const status = document.getElementById('status');
    const container = document.getElementById('chart-container');
    const drilldown = document.getElementById('drilldown');

    const terms = parseTerms(input);
    if (terms.length === 0) return;

    status.textContent = 'Searching...';
    container.style.display = 'none';
    drilldown.style.display = 'none';

    try {
        // Fetch all terms in parallel
        const fetches = terms.map(term =>
            fetch(SEARCH_URL + '?term=' + encodeURIComponent(term) + '&lang=' + currentLang).then(r => r.json())
        );
        const results = await Promise.all(fetches);

        // Check for errors
        const errors = results.filter(d => d.error);
        if (errors.length > 0) {
            status.textContent = errors.map(d => d.error).join('; ');
            return;
        }

        // Filter out terms with zero results
        const hasResults = results.filter(d => d.total_count > 0);
        const noResults = results.filter(d => d.total_count === 0);

        if (hasResults.length === 0) {
            status.textContent = `No results for "${terms.join('", "')}"`;
            return;
        }

        // Show warning for terms with no results, but still plot the rest
        if (noResults.length > 0) {
            status.textContent = `No results for: ${noResults.map(d => '"' + d.term + '"').join(', ')}`;
        } else {
            status.textContent = '';
        }

        lastResults = hasResults;
        renderChart(hasResults);
        showTopHomilies(hasResults);

        // Update URL with comma-separated terms and language
        const url = new URL(window.location);
        url.searchParams.set('term', terms.join(','));
        if (currentLang !== 'es') {
            url.searchParams.set('lang', currentLang);
        } else {
            url.searchParams.delete('lang');
        }
        history.replaceState(null, '', url);

    } catch (e) {
        status.textContent = 'Search failed: ' + e.message;
    }
}

// Search form
document.getElementById('search-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('term').value.trim();
    if (input) doSearch(input);
});

// Example links
document.getElementById('examples').addEventListener('click', function(e) {
    if (e.target.dataset.term) {
        e.preventDefault();
        document.getElementById('term').value = e.target.dataset.term;
        doSearch(e.target.dataset.term);
    }
});

// Re-render on control change
document.getElementById('norm').addEventListener('change', function() {
    if (lastResults.length) { renderChart(lastResults); showTopHomilies(lastResults); }
});
document.getElementById('smoothing').addEventListener('change', function() {
    if (lastResults.length) { renderChart(lastResults); showTopHomilies(lastResults); }
});
document.getElementById('show-events').addEventListener('change', function() {
    if (lastResults.length) { renderChart(lastResults); showTopHomilies(lastResults); }
});

// Language toggle
function setLang(lang) {
    currentLang = lang;
    document.querySelectorAll('#lang-toggle button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });
    document.getElementById('examples').innerHTML = LANG_CONFIG[lang].examples;
}

document.getElementById('lang-toggle').addEventListener('click', function(e) {
    const btn = e.target.closest('button[data-lang]');
    if (!btn || btn.dataset.lang === currentLang) return;
    setLang(btn.dataset.lang);
    // If the current search term matches the other language's default, swap it
    const input = document.getElementById('term');
    const otherLang = btn.dataset.lang === 'es' ? 'en' : 'es';
    if (input.value.trim() === LANG_CONFIG[otherLang].defaultTerm) {
        input.value = LANG_CONFIG[btn.dataset.lang].defaultTerm;
    }
    doSearch(input.value.trim());
});

// Auto-search from URL, or default
const params = new URLSearchParams(window.location.search);
const initialLang = params.get('lang') === 'en' ? 'en' : 'es';
setLang(initialLang);
const initialTerm = params.get('term') || LANG_CONFIG[currentLang].defaultTerm;
document.getElementById('term').value = initialTerm;
doSearch(initialTerm);
</script>
</body>
</html>
